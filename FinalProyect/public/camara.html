<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cajero - C치maaras</title>
  <link rel="stylesheet" href="css/styles.css"/>
</head>

<body>
  <header>
    <img src="/img/loguito.jpeg" alt="Logo" class="header-logo"/>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="vista_salon.html">Vista Sal칩n</a></li>
        <li><a href="planilla.html">Planilla</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Contenedor principal blanco que ocupa casi toda la pantalla -->
    <div class="cajero-container">
      <!-- Izquierda: Secci칩n de c치mara -->
      <div class="cajero-left">
        <h2>Live Feed (C치mara)</h2>
        <!-- Secci칩n de Listado de Placas -->
        <section id="plates-section">
          <p>
            <strong>칔ltima Placa Detectada:</strong>
            <span id="detected-plate">No se ha detectado ninguna placa a칰n</span>
          </p>
          <p>
            <strong>Timestamp:</strong>
            <span id="timestamp">--</span>
          </p>
        </section>

        <div class="cam-feed">
          <!-- Secci칩n de la c치mara en vivo -->
          <h3>C치mara en vivo</h3>
          <img 
            src="http://192.168.0.238:5001/video_feed" 
            alt="video_feed" 
            style="max-width: 400px; border: 1px solid #ccc;"
          />

          <!-- Secci칩n de la imagen OCR (la placa detectada) -->
          <h3>Placa Detectada (Imagen OCR)</h3>
          <img 
            src="http://3.82.125.113/last-ocr-image" 
            alt="ocr_feed"
            style="max-width: 400px; border: 1px solid #ccc;"
          />
        </div>
      </div>
      
      <!-- Derecha: Secci칩n de formulario o panel del cajero -->
      <div class="cajero-right">
        <h2>Formulario de Servicio</h2>
        <form id="cajero-form">
          <label>Nombre del cliente</label>
          <input type="text" id="nombre-dueno" placeholder="Nombre del due침o" />
        
          <label>N칰mero de tel칠fono</label>
          <input type="text" id="telefono" placeholder="N칰mero de tel칠fono" />
        
          <label>Categor칤a</label>
          <select id="categoria-select">
            <option value="">Categor칤a</option>
            <option value="lavados">Lavados</option>
            <option value="manoObra">Mano de Obra</option>
            <option value="especializados">Servicios Especializados</option>
            <option value="tecnicentro">Tecnicentro</option>
          </select>
        
          <!-- Este div se mostrar치 solo cuando se elija una categor칤a -->
          <div id="servicio-group" style="display: none;">
            <label>Servicio</label>
            <select id="servicio-select">
              <option value="">Servicio</option>
            </select>
          </div>

          <div id="precio-estimado" style="margin-top: 10px; font-weight: bold; color: #af267a;"></div>

          <label>Tipo de carro</label>
          <select id="tipo-carro">
            <option value="Sedan">Sedan</option>
            <option value="Hatchback">Hatchback</option>
            <option value="SUV">SUV</option>
          </select>
        
          <label>Operarios asignados</label>
          <select id="operarios">
            <option value="Grupo 1">Grupo 1</option>
            <option value="Grupo 2">Grupo 2</option>
          </select>
        
          <label>Ofertas</label>
          <select>
            <option value="Ninguna">Ninguna</option>
            <option value="Descuento 10%">Descuento 10%</option>
          </select>
        
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </main>

  <!-- Scripts para Socket.IO y l칩gica del cliente -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
     const socket = io();

// Cuando se recibe un update de placa, se actualizan los textos correspondientes
    socket.on('updatePlaca', (data) => {
      document.getElementById('detected-plate').textContent = data.placa;
      document.getElementById('timestamp').textContent = data.timestamp;
      console.log("Se detect칩 una placa:", data.placa);

      // Verificar la placa y actualizar los datos autom치ticamente en el formulario
      verificarPlacaYMostrarDatos(data.placa);

      // Opcional: Forzar la recarga de la imagen OCR para evitar cach칠
      const ocrImage = document.querySelector('img[alt="ocr_feed"]');
      ocrImage.src = "http://3.82.125.113/last-ocr-image?time=" + new Date().getTime();
});

// Funci칩n que verifica si la placa est치 registrada y llena los campos del formulario
function verificarPlacaYMostrarDatos(placa) {
  // Hacer una consulta a la API para verificar si la placa ya existe en la base de datos
  fetch(`/verificar-vehiculo?placa=${placa}`)
    .then(response => response.json())
    .then(data => {
      if (data.nombre_dueno && data.telefono) {
        // Si la placa est치 registrada, llenar los campos con la informaci칩n del cliente
        document.getElementById('nombre-dueno').value = data.nombre_dueno;
        document.getElementById('telefono').value = data.telefono;
      } else {
        // Si no est치 registrada, los campos deben quedar vac칤os
        document.getElementById('nombre-dueno').value = '';
        document.getElementById('telefono').value = '';
      }
    })
    .catch(err => console.error('Error al verificar la placa:', err));
}
  </script>

  <script>
    // Funci칩n que verifica si la placa est치 registrada y llena los campos del formulario
    function verificarPlacaYMostrarDatos(placa) {
      // Hacer una consulta a la API para verificar si la placa ya existe en la base de datos
      fetch(`/verificar-vehiculo?placa=${placa}`)
        .then(response => response.json())
        .then(data => {
          if (data.nombre_dueno && data.telefono) {
            // Si la placa est치 registrada, llenar los campos con la informaci칩n del cliente
            document.getElementById('nombre-dueno').value = data.nombre_dueno;
            document.getElementById('telefono').value = data.telefono;
          } else {
            // Si no est치 registrada, los campos deben quedar vac칤os
            document.getElementById('nombre-dueno').value = '';
            document.getElementById('telefono').value = '';
          }
        })
        .catch(err => console.error('Error al verificar la placa:', err));
    }
  </script>

  <!-- Script para verificaci칩n de usuario autenticado -->
  <script>
    fetch('/user-info')
      .then(response => {
        if (!response.ok) {
          window.location.href = "/principal.html"; 
          return Promise.reject("Usuario no autenticado. Redirigiendo...");
        }
        return response.json();
      })
      .then(data => {
        console.log("Usuario autenticado:", data.username);
      })
      .catch(err => console.error('Error obteniendo informaci칩n del usuario:', err));
  </script>

  <script>
    const categoriaSelect = document.getElementById("categoria-select");
    const servicioSelect = document.getElementById("servicio-select");
    const servicioGroup = document.getElementById("servicio-group");
    const precioDiv = document.getElementById("precio-estimado");
  
    let serviciosPorCategoria = {};

    fetch('/servicios')
      .then(response => response.json())
      .then(data => {
        data.forEach(servicio => {
          if (!serviciosPorCategoria[servicio.categoria]) {
            serviciosPorCategoria[servicio.categoria] = [];
          }
          serviciosPorCategoria[servicio.categoria].push(servicio);
        });
      })
      .catch(err => console.error("Error cargando servicios:", err));

    if (categoriaSelect && servicioSelect && servicioGroup && precioDiv) {
      categoriaSelect.addEventListener("change", function () {
        const categoria = this.value;
        const servicios = serviciosPorCategoria[categoria] || [];

        if (!categoria) {
          servicioGroup.style.display = "none";
          servicioSelect.innerHTML = '<option value="">Servicio</option>';
          precioDiv.innerHTML = "";
          return;
        }

        servicioGroup.style.display = "block";
        servicioSelect.innerHTML = '<option value="">-- Selecciona un servicio --</option>';

        servicios.forEach(servicio => {
          const option = document.createElement("option");
          option.value = servicio.nombre;
          option.textContent = servicio.nombre;
          option.dataset.precio = servicio.precio;
          servicioSelect.appendChild(option);
        });

        precioDiv.innerHTML = "";
      });

      servicioSelect.addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const precio = selectedOption.dataset.precio;

        if (precio) {
          precioDiv.innerHTML = `游눯 Precio estimado: <strong>$${parseInt(precio).toLocaleString("es-CO")}</strong>`;
        } else {
          precioDiv.innerHTML = "";
        }
      });
    }
  </script>

  <script>
    document.getElementById('cajero-form').addEventListener('submit', function(event) {
      event.preventDefault(); // Previene el comportamiento por defecto del formulario (recarga de p치gina)
      
      const placa = document.getElementById('detected-plate').textContent;  // La placa detectada
      const nombre_dueno = document.getElementById('nombre-dueno').value;
      const telefono = document.getElementById('telefono').value;
      const categoria = document.getElementById('categoria-select').value;
      
      // Ahora obtenemos correctamente el valor seleccionado para el tipo de carro
      const tipo_carro = document.querySelector('select[id="tipo-carro"]').value;  // Tipo de carro
      const operarios = document.querySelector('select[id="operarios"]').value;  // Operarios asignados
      const servicios = document.getElementById('servicio-select').value;
      const precio_total = document.getElementById('precio-estimado').textContent.match(/\d+/g).join('');

      // Enviar los datos al servidor
      fetch('/guardar-registro', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              placa,
              nombre_dueno,
              telefono,
              categoria,
              tipo_carro,  // Enviamos el valor correcto
              operarios,  // Enviamos el operario seleccionado
              servicios,
              precio_total
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert("Registro guardado correctamente.");
              // Aqu칤 puedes agregar l칩gica para limpiar los campos o dar retroalimentaci칩n al usuario
          } else {
              alert("Hubo un error al guardar el registro.");
          }
      })
      .catch(err => console.error('Error al enviar el formulario:', err));
  });
</script>

</body>
</html>